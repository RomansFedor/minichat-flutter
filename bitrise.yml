format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - BITRISE_FLUTTER_PROJECT_DIR: "."
  - BITRISE_FLUTTER_PROJECT_LOCATION: "."

workflows:
  primary:
    description: "Primary workflow for building and deploying Flutter Android app"
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@6: {}
    - install-missing-android-tools@3:
        inputs:
        - gradle_version: "8.0"
    - cache-pull@2: {}
    - flutter-installer@0:
        inputs:
        - channel: "beta"
        - is_update: "true"
    - script@1:
        title: "Verify Flutter/Dart versions (requires Dart 3.9.2+)"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "=== Ensuring Flutter is on beta channel and up to date ==="
            flutter channel beta
            flutter upgrade --force
            
            echo "=== Current Flutter and Dart versions ==="
            flutter --version
            dart --version
            
            echo "=== Verifying Dart SDK >= 3.9.2 ==="
            DART_VERSION=$(dart --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            echo "Detected Dart version: $DART_VERSION"
            REQUIRED_VERSION="3.9.2"
            
            # Parse version numbers
            MAJOR=$(echo $DART_VERSION | cut -d. -f1)
            MINOR=$(echo $DART_VERSION | cut -d. -f2)
            PATCH=$(echo $DART_VERSION | cut -d. -f3)
            REQ_MAJOR=$(echo $REQUIRED_VERSION | cut -d. -f1)
            REQ_MINOR=$(echo $REQUIRED_VERSION | cut -d. -f2)
            REQ_PATCH=$(echo $REQUIRED_VERSION | cut -d. -f3)
            
            # Check if version is sufficient
            if [ $MAJOR -lt $REQ_MAJOR ] || ([ $MAJOR -eq $REQ_MAJOR ] && [ $MINOR -lt $REQ_MINOR ]) || ([ $MAJOR -eq $REQ_MAJOR ] && [ $MINOR -eq $REQ_MINOR ] && [ $PATCH -lt $REQ_PATCH ]); then
              echo "ERROR: Dart version $DART_VERSION is lower than required $REQUIRED_VERSION"
              echo "Even beta channel doesn't have the required version. Please check Flutter releases."
              exit 1
            fi
            
            echo "✓ Dart version check passed: $DART_VERSION >= $REQUIRED_VERSION"
    - script@1:
        title: "Create google-services.json from Secret"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "========================================"
            echo "Creating google-services.json"
            echo "========================================"
            cd "$BITRISE_FLUTTER_PROJECT_DIR"
            pwd
            ls -la android/app/ 2>/dev/null || echo "android/app directory does not exist yet"
            
            if [ -z "$GOOGLE_SERVICES_JSON" ]; then
              echo "ERROR: GOOGLE_SERVICES_JSON secret is not set in Bitrise"
              echo "Please add GOOGLE_SERVICES_JSON secret with the content of android/app/google-services.json"
              echo "To get the content, run: cat android/app/google-services.json"
              exit 1
            fi
            
            echo "✓ GOOGLE_SERVICES_JSON secret is set (length: ${#GOOGLE_SERVICES_JSON} characters)"
            echo "First 50 chars of secret: ${GOOGLE_SERVICES_JSON:0:50}"
            
            # Create the directory if it doesn't exist
            mkdir -p android/app
            echo "✓ Directory android/app created/verified"
            
            # Write the JSON content to the file
            echo "$GOOGLE_SERVICES_JSON" > android/app/google-services.json
            echo "✓ File write command executed"
            
            # Verify file was created
            if [ ! -f android/app/google-services.json ]; then
              echo "ERROR: Failed to create google-services.json"
              echo "Current directory: $(pwd)"
              echo "Directory contents:"
              ls -la android/app/ || echo "Cannot list android/app/"
              exit 1
            fi
            
            # Verify file is not empty
            FILE_SIZE=$(wc -c < android/app/google-services.json | tr -d ' ')
            if [ "$FILE_SIZE" -eq 0 ]; then
              echo "ERROR: google-services.json is empty"
              exit 1
            fi
            
            echo "✓ google-services.json created successfully"
            echo "File location: $(pwd)/android/app/google-services.json"
            echo "File size: $FILE_SIZE bytes"
            echo "First 200 chars:"
            head -c 200 android/app/google-services.json
            echo ""
            echo "Last 50 chars:"
            tail -c 50 android/app/google-services.json
            echo ""
            echo "========================================"
    - script@1:
        title: "Clean and get Flutter dependencies"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "=== Cleaning Flutter build cache ==="
            cd "$BITRISE_FLUTTER_PROJECT_DIR"
            flutter clean || echo "Warning: flutter clean failed, continuing..."
            echo "=== Getting Flutter dependencies ==="
            flutter pub get
    - flutter-test@0:
        inputs:
        - project_location: "$BITRISE_FLUTTER_PROJECT_DIR"
    - flutter-build@0:
        inputs:
        - project_location: "$BITRISE_FLUTTER_PROJECT_DIR"
        - platform: "android"
        - build_apk: "true"
        - build_appbundle: "false"
        - build_configuration: "release"
    - firebase-app-distribution@2:
        inputs:
        - firebase_token: "$FIREBASE_TOKEN"
        - app_path: "$BITRISE_FLUTTER_PROJECT_DIR/build/app/outputs/flutter-apk/app-release.apk"
        - groups: "$FIREBASE_GROUPS"
        - release_notes: "$BITRISE_GIT_MESSAGE"
    - cache-push@2: {}

  deploy:
    description: "Deploy workflow with Firebase App Distribution"
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@6: {}
    - install-missing-android-tools@3:
        inputs:
        - gradle_version: "8.0"
    - cache-pull@2: {}
    - flutter-installer@0:
        inputs:
        - channel: "beta"
        - is_update: "true"
    - script@1:
        title: "Verify Flutter/Dart versions (requires Dart 3.9.2+)"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "=== Ensuring Flutter is on beta channel and up to date ==="
            flutter channel beta
            flutter upgrade --force
            
            echo "=== Current Flutter and Dart versions ==="
            flutter --version
            dart --version
            
            echo "=== Verifying Dart SDK >= 3.9.2 ==="
            DART_VERSION=$(dart --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            echo "Detected Dart version: $DART_VERSION"
            REQUIRED_VERSION="3.9.2"
            
            # Parse version numbers
            MAJOR=$(echo $DART_VERSION | cut -d. -f1)
            MINOR=$(echo $DART_VERSION | cut -d. -f2)
            PATCH=$(echo $DART_VERSION | cut -d. -f3)
            REQ_MAJOR=$(echo $REQUIRED_VERSION | cut -d. -f1)
            REQ_MINOR=$(echo $REQUIRED_VERSION | cut -d. -f2)
            REQ_PATCH=$(echo $REQUIRED_VERSION | cut -d. -f3)
            
            # Check if version is sufficient
            if [ $MAJOR -lt $REQ_MAJOR ] || ([ $MAJOR -eq $REQ_MAJOR ] && [ $MINOR -lt $REQ_MINOR ]) || ([ $MAJOR -eq $REQ_MAJOR ] && [ $MINOR -eq $REQ_MINOR ] && [ $PATCH -lt $REQ_PATCH ]); then
              echo "ERROR: Dart version $DART_VERSION is lower than required $REQUIRED_VERSION"
              echo "Even beta channel doesn't have the required version. Please check Flutter releases."
              exit 1
            fi
            
            echo "✓ Dart version check passed: $DART_VERSION >= $REQUIRED_VERSION"
    - script@1:
        title: "Create google-services.json from Secret"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "========================================"
            echo "Creating google-services.json"
            echo "========================================"
            cd "$BITRISE_FLUTTER_PROJECT_DIR"
            pwd
            ls -la android/app/ 2>/dev/null || echo "android/app directory does not exist yet"
            
            if [ -z "$GOOGLE_SERVICES_JSON" ]; then
              echo "ERROR: GOOGLE_SERVICES_JSON secret is not set in Bitrise"
              echo "Please add GOOGLE_SERVICES_JSON secret with the content of android/app/google-services.json"
              echo "To get the content, run: cat android/app/google-services.json"
              exit 1
            fi
            
            echo "✓ GOOGLE_SERVICES_JSON secret is set (length: ${#GOOGLE_SERVICES_JSON} characters)"
            echo "First 50 chars of secret: ${GOOGLE_SERVICES_JSON:0:50}"
            
            # Create the directory if it doesn't exist
            mkdir -p android/app
            echo "✓ Directory android/app created/verified"
            
            # Write the JSON content to the file
            echo "$GOOGLE_SERVICES_JSON" > android/app/google-services.json
            echo "✓ File write command executed"
            
            # Verify file was created
            if [ ! -f android/app/google-services.json ]; then
              echo "ERROR: Failed to create google-services.json"
              echo "Current directory: $(pwd)"
              echo "Directory contents:"
              ls -la android/app/ || echo "Cannot list android/app/"
              exit 1
            fi
            
            # Verify file is not empty
            FILE_SIZE=$(wc -c < android/app/google-services.json | tr -d ' ')
            if [ "$FILE_SIZE" -eq 0 ]; then
              echo "ERROR: google-services.json is empty"
              exit 1
            fi
            
            echo "✓ google-services.json created successfully"
            echo "File location: $(pwd)/android/app/google-services.json"
            echo "File size: $FILE_SIZE bytes"
            echo "First 200 chars:"
            head -c 200 android/app/google-services.json
            echo ""
            echo "Last 50 chars:"
            tail -c 50 android/app/google-services.json
            echo ""
            echo "========================================"
    - script@1:
        title: "Clean and get Flutter dependencies"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "=== Cleaning Flutter build cache ==="
            cd "$BITRISE_FLUTTER_PROJECT_DIR"
            flutter clean || echo "Warning: flutter clean failed, continuing..."
            echo "=== Getting Flutter dependencies ==="
            flutter pub get
    - flutter-test@0:
        inputs:
        - project_location: "$BITRISE_FLUTTER_PROJECT_DIR"
    - flutter-build@0:
        inputs:
        - project_location: "$BITRISE_FLUTTER_PROJECT_DIR"
        - platform: "android"
        - build_apk: "true"
        - build_appbundle: "false"
        - build_configuration: "release"
    - firebase-app-distribution@2:
        inputs:
        - firebase_token: "$FIREBASE_TOKEN"
        - app_path: "$BITRISE_FLUTTER_PROJECT_DIR/build/app/outputs/flutter-apk/app-release.apk"
        - groups: "$FIREBASE_GROUPS"
        - release_notes: "$BITRISE_GIT_MESSAGE"
    - cache-push@2: {}
