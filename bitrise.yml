format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - BITRISE_FLUTTER_PROJECT_DIR: "."
  - BITRISE_FLUTTER_PROJECT_LOCATION: "."

workflows:
  primary:
    description: "Primary workflow for building and deploying Flutter Android app"
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@6: {}
    - install-missing-android-tools@3:
        inputs:
        - gradle_version: "8.0"
    - cache-pull@2: {}
    - flutter-installer@0:
        inputs:
        - channel: "stable"
        - is_update: "true"
    - script@1:
        title: "Verify and Upgrade Flutter/Dart versions"
        is_always_run: true
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "=== Initial Flutter Version ==="
            flutter --version
            echo "=== Initial Dart Version ==="
            dart --version
            echo "=== Upgrading Flutter to latest stable ==="
            flutter upgrade --force
            echo "=== After Upgrade - Flutter Version ==="
            flutter --version
            echo "=== After Upgrade - Dart Version ==="
            dart --version
            echo "=== Verifying Dart SDK >= 3.9.2 ==="
            DART_VERSION=$(dart --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            echo "Detected Dart version: $DART_VERSION"
            REQUIRED_VERSION="3.9.2"
            if [ "$DART_VERSION" != "" ]; then
              MAJOR=$(echo $DART_VERSION | cut -d. -f1)
              MINOR=$(echo $DART_VERSION | cut -d. -f2)
              PATCH=$(echo $DART_VERSION | cut -d. -f3)
              REQ_MAJOR=$(echo $REQUIRED_VERSION | cut -d. -f1)
              REQ_MINOR=$(echo $REQUIRED_VERSION | cut -d. -f2)
              REQ_PATCH=$(echo $REQUIRED_VERSION | cut -d. -f3)
              if [ $MAJOR -lt $REQ_MAJOR ] || ([ $MAJOR -eq $REQ_MAJOR ] && [ $MINOR -lt $REQ_MINOR ]) || ([ $MAJOR -eq $REQ_MAJOR ] && [ $MINOR -eq $REQ_MINOR ] && [ $PATCH -lt $REQ_PATCH ]); then
                echo "ERROR: Dart version $DART_VERSION is still lower than required $REQUIRED_VERSION after upgrade"
                exit 1
              fi
              echo "✓ Dart version check passed: $DART_VERSION >= $REQUIRED_VERSION"
            else
              echo "ERROR: Could not detect Dart version"
              exit 1
            fi
            echo "=== Cleaning Flutter build cache ==="
            cd "$BITRISE_FLUTTER_PROJECT_DIR"
            flutter clean || echo "Warning: flutter clean failed, continuing..."
    - script@1:
        title: "Get Flutter dependencies"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            cd "$BITRISE_FLUTTER_PROJECT_DIR"
            flutter pub get
    - flutter-test@0:
        inputs:
        - project_location: "$BITRISE_FLUTTER_PROJECT_DIR"
    - flutter-build@0:
        inputs:
        - project_location: "$BITRISE_FLUTTER_PROJECT_DIR"
        - platform: "android"
        - build_apk: "true"
        - build_appbundle: "false"
        - build_configuration: "release"
    - firebase-app-distribution@2:
        inputs:
        - firebase_token: "$FIREBASE_TOKEN"
        - app_path: "$BITRISE_FLUTTER_PROJECT_DIR/build/app/outputs/flutter-apk/app-release.apk"
        - groups: "$FIREBASE_GROUPS"
        - release_notes: "$BITRISE_GIT_MESSAGE"
    - cache-push@2: {}

  deploy:
    description: "Deploy workflow with Firebase App Distribution"
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@6: {}
    - install-missing-android-tools@3:
        inputs:
        - gradle_version: "8.0"
    - cache-pull@2: {}
    - flutter-installer@0:
        inputs:
        - channel: "stable"
        - is_update: "true"
    - script@1:
        title: "Verify and Upgrade Flutter/Dart versions"
        is_always_run: true
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "=== Initial Flutter Version ==="
            flutter --version
            echo "=== Initial Dart Version ==="
            dart --version
            echo "=== Upgrading Flutter to latest stable ==="
            flutter upgrade --force
            echo "=== After Upgrade - Flutter Version ==="
            flutter --version
            echo "=== After Upgrade - Dart Version ==="
            dart --version
            echo "=== Verifying Dart SDK >= 3.9.2 ==="
            DART_VERSION=$(dart --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            echo "Detected Dart version: $DART_VERSION"
            REQUIRED_VERSION="3.9.2"
            if [ "$DART_VERSION" != "" ]; then
              MAJOR=$(echo $DART_VERSION | cut -d. -f1)
              MINOR=$(echo $DART_VERSION | cut -d. -f2)
              PATCH=$(echo $DART_VERSION | cut -d. -f3)
              REQ_MAJOR=$(echo $REQUIRED_VERSION | cut -d. -f1)
              REQ_MINOR=$(echo $REQUIRED_VERSION | cut -d. -f2)
              REQ_PATCH=$(echo $REQUIRED_VERSION | cut -d. -f3)
              if [ $MAJOR -lt $REQ_MAJOR ] || ([ $MAJOR -eq $REQ_MAJOR ] && [ $MINOR -lt $REQ_MINOR ]) || ([ $MAJOR -eq $REQ_MAJOR ] && [ $MINOR -eq $REQ_MINOR ] && [ $PATCH -lt $REQ_PATCH ]); then
                echo "ERROR: Dart version $DART_VERSION is still lower than required $REQUIRED_VERSION after upgrade"
                exit 1
              fi
              echo "✓ Dart version check passed: $DART_VERSION >= $REQUIRED_VERSION"
            else
              echo "ERROR: Could not detect Dart version"
              exit 1
            fi
            echo "=== Cleaning Flutter build cache ==="
            cd "$BITRISE_FLUTTER_PROJECT_DIR"
            flutter clean || echo "Warning: flutter clean failed, continuing..."
    - script@1:
        title: "Get Flutter dependencies"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            cd "$BITRISE_FLUTTER_PROJECT_DIR"
            flutter pub get
    - flutter-test@0:
        inputs:
        - project_location: "$BITRISE_FLUTTER_PROJECT_DIR"
    - flutter-build@0:
        inputs:
        - project_location: "$BITRISE_FLUTTER_PROJECT_DIR"
        - platform: "android"
        - build_apk: "true"
        - build_appbundle: "false"
        - build_configuration: "release"
    - firebase-app-distribution@2:
        inputs:
        - firebase_token: "$FIREBASE_TOKEN"
        - app_path: "$BITRISE_FLUTTER_PROJECT_DIR/build/app/outputs/flutter-apk/app-release.apk"
        - groups: "$FIREBASE_GROUPS"
        - release_notes: "$BITRISE_GIT_MESSAGE"
    - cache-push@2: {}
